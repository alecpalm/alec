<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SBA Email Template Builder</title>
  <link rel="icon" href="/files/apfavi.png" type="image/x-icon">
  <style>
    :root{--bg:#f8fafc;--panel:#ffffff;--panel-alt:#f8fafc;--text:#1f2937;--muted:#6b7280;--accent:#3b82f6;--primary:rgb(24 24 27);--radius:14px;--shadow:0 8px 24px rgba(0,0,0,.08);--shadow-hover:0 12px 32px rgba(0,0,0,.12)}
    *{box-sizing:border-box}
    body{margin:0;font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, Noto Sans, "Apple Color Emoji", "Segoe UI Emoji";color:var(--text);background:var(--bg)}
    .container{max-width:1200px;margin:0 auto;padding:20px;animation:fadeIn 0.4s ease-out}
    header{display:flex;gap:14px;align-items:center;justify-content:space-between;margin-bottom:16px}
    @media (max-width: 768px) {
      header{flex-direction:row;padding:8px 12px;margin-bottom:16px;flex-wrap:wrap;min-height:40px;justify-content:center}
      .brand{display:none}
      .logo{display:none}
      h1{display:none}
      .btnbar{order:2;display:flex;gap:4px;flex-shrink:0;align-items:center}
      .btn{font-size:11px;padding:4px 8px;border-radius:4px;font-weight:500;white-space:nowrap;min-width:fit-content}
      .container{padding:16px 12px}
    }
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes fadeInUp{from{opacity:0}to{opacity:1}}
    @keyframes fadeOutDown{from{opacity:1;transform:translateY(0)}to{opacity:0;transform:translateY(-20px)}}
    @keyframes slideInFade{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
    @keyframes slideDownFade{from{opacity:0;max-height:0;padding-top:0;padding-bottom:0;margin-bottom:0;transform:translateY(-5px)}to{opacity:1;max-height:50px;padding-top:8px;padding-bottom:16px;margin-bottom:12px;transform:translateY(0)}}
    @keyframes slideUpFade{from{opacity:1;max-height:50px;padding-top:8px;padding-bottom:16px;margin-bottom:12px;transform:translateY(0)}to{opacity:0;max-height:0;padding-top:0;padding-bottom:0;margin-bottom:0;transform:translateY(-5px)}}
    .resetting{animation:fadeIn 0.4s ease-out forwards}
    .logo-black{filter: invert(1) brightness(0.8)}
    .brand{display:flex;gap:10px;align-items:center}
    .logo-link{text-decoration:none}
    .logo{width:32px;height:32px;border-radius:8px;background:var(--primary);color:#ffffff;font-weight:700;font-size:12px;display:flex;align-items:center;justify-content:center;}
    h1{font-size:18px;margin:0;font-weight:700;letter-spacing:.2px}
    .layout{display:block}
    .panel{background:var(--panel);border-radius:var(--radius);box-shadow:var(--shadow);border:1px solid #f1f5f9}
    .controls{padding:20px;margin-bottom:32px}
    .section{border:1px solid #e5e7eb;border-radius:12px;padding:16px;margin-bottom:20px;background:linear-gradient(135deg,#ffffff 0%,#fafbfc 100%);box-shadow:0 2px 8px rgba(0,0,0,.04)}
    .section h3{margin:0 0 12px 0;font-size:14px;font-weight:600}
    label{display:block;font-size:12px;color:var(--muted);margin:12px 0 8px;font-weight:500}
    input[type="text"], input[type="url"], textarea, select{width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:10px;background:#ffffff;color:var(--text);font-size:14px;margin-top:8px;margin-bottom:16px;transition:all 0.2s ease}
    input[type="text"]:focus, input[type="url"]:focus, textarea:focus, select:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(59,130,246,0.1);outline:none}
    textarea{min-height:80px;resize:vertical}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .row{display:flex;gap:12px;align-items:center;margin-top:12px}
    .color-input{display:flex;gap:8px;align-items:center}
    .swatch{width:28px;height:28px;border-radius:8px;border:1px solid #e5e7eb}
    .btn{appearance:none;border:0;border-radius:10px;padding:10px 12px;font-weight:600;cursor:pointer;transition:all 0.2s ease}
    .btn.primary{background:var(--primary);color:#fff;box-shadow:0 2px 8px rgba(0,0,0,.15)}
    .btn.primary:hover{box-shadow:0 4px 12px rgba(0,0,0,.2);transform:translateY(-1px)}
    .btn.ghost{background:#f3f4f6;color:#374151;border:1px solid #e5e7eb}
    .btn.ghost:hover{background:#e5e7eb;color:#1f2937;border-color:#d1d5db}
    .btnbar{display:flex;gap:10px;flex-wrap:wrap}
    .preset-list{display:none}
    .preset{display:none}
    .preview{padding:12px}
    .iframe-wrap{background:#ffffff;border-radius:12px;border:1px solid #e5e7eb;overflow:hidden;max-width:700px;margin:0 auto}
    .footer-note{color:var(--muted);font-size:12px;margin-top:8px}
    .btn.selected{outline:2px solid var(--primary); background:#e5e7eb}
    .toolbar{display:flex;gap:4px;flex-wrap:wrap;border:1px solid #e5e7eb;border-radius:12px;padding:12px;background:linear-gradient(135deg,#ffffff 0%,#fafbfc 100%);position:sticky;top:0;z-index:100;transition: all 0.3s ease;backdrop-filter: blur(10px);margin-bottom:16px;box-shadow:0 2px 8px rgba(0,0,0,.04);}
    .toolbar.sticky{transform: scale(1.05); padding: 14px; box-shadow: 0 6px 20px rgba(0,0,0,.15);}
    .toolbar button{border:1px solid #e5e7eb;background:#ffffff;border-radius:8px;padding:8px 12px;font-size:13px;font-weight:500;cursor:pointer;color:#374151;transition: all 0.2s ease;min-width:36px;display:flex;align-items:center;justify-content:center;gap:4px;}
    .toolbar button:hover{background:#f8fafc;border-color:#d1d5db;transform: translateY(-1px);box-shadow: 0 2px 8px rgba(0,0,0,.1);}
    .toolbar button:active{transform: translateY(0);}
    .rte{border:1px solid #e5e7eb;border-radius:10px;min-height:100px;padding:12px;background:#ffffff;color:var(--text);font-size:14px;line-height:1.5;margin-top:8px;margin-bottom:16px;transition:all 0.2s ease}
    .rte:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(59,130,246,0.1);outline:none}
    .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:2000;backdrop-filter:blur(4px);opacity:0;visibility:hidden;transition:all 0.2s ease}
    .modal-overlay.show{opacity:1;visibility:visible}
    .modal{display:flex;flex-direction:column;background:#ffffff;border-radius:12px;padding:24px;max-width:400px;width:90%;box-shadow:0 20px 40px rgba(0,0,0,.15);transform:scale(0.9);transition:transform 0.2s ease}
    .modal-overlay.show .modal{transform:scale(1)}
    .modal h3{margin:0 0 16px 0;font-size:18px;font-weight:600;color:#1f2937}
    .modal p{margin:0 0 20px 0;color:#6b7280;line-height:1.5}
    .modal input{width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:8px;margin-bottom:20px;font-size:14px}
    .modal input:focus{border-color:var(--accent);outline:none;box-shadow:0 0 0 3px rgba(59,130,246,0.1)}
    .modal-buttons{display:flex;gap:12px;justify-content:flex-end}
    .modal-btn{padding:10px 16px;border-radius:8px;font-weight:500;cursor:pointer;border:1px solid #e5e7eb;background:#f9fafb;color:#374151;transition:all 0.2s ease}
    .modal-btn:hover{background:#f3f4f6}
    .modal-btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
    .modal-btn.primary:hover{box-shadow:0 4px 12px rgba(24,24,27,0.3)}
    .section.new-section{animation:slideInFade 0.4s ease-out}
    .title-container.show-title{animation:slideDownFade 0.3s ease-out}
    .title-container.hide-title{animation:slideUpFade 0.3s ease-in forwards}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <a href="index" class="logo-link"><div class="logo">AP</div></a>
        <div>
          <h1>SBA Email Template Builder</h1>
        </div>
      </div>
      <div class="btnbar">
        <button id="copyHtml" class="btn primary">Copy HTML for Gmail</button>
        <button id="resetDefaults" class="btn ghost">Reset</button>
      </div>
    </header>

    <div class="layout">
      <div class="panel controls">
        <div class="toolbar" id="rteToolbar">
          <button data-cmd="bold"><b>B</b></button>
          <button data-cmd="italic"><i>I</i></button>
          <button data-cmd="underline"><u>U</u></button>
          <button data-cmd="insertUnorderedList">â€¢ List</button>
          <button data-cmd="insertOrderedList">1. List</button>
          <button data-action="link">Link</button>
          <button data-action="clearFormat">Clear</button>
        </div>
        <div class="section">
          <h3>Branding</h3>
          <div class="grid-2">
            <div>
              <label>Primary Color</label>
              <div class="color-input">
                <input id="primaryColor" type="color" value="#65ab6f">
                <input id="primaryHex" type="text" value="#65ab6f">
              </div>
            </div>
            <div>
              <label>Hero Text Color</label>
              <div class="color-input">
                <input id="heroTextColor" type="color" value="#ffffff">
                <input id="heroTextHex" type="text" value="#ffffff">
              </div>
            </div>
          </div>
          <label>Logo Style</label>
          <div class="row">
            <button id="logoBlue" class="btn ghost" type="button">Blue</button>
            <button id="logoWhite" class="btn ghost selected" type="button">White</button>
            <button id="logoBlack" class="btn ghost" type="button">Black</button>
          </div>
        </div>

        <div class="section">
          <h3>Hero</h3>
          <label>Headline</label>
          <div id="headlineEditor" class="rte" contenteditable="true"></div>
          <label>Subheadline</label>
          <div id="subheadlineEditor" class="rte" contenteditable="true"></div>
          <label>Preheader (inbox preview)</label>
          <input id="preheader" type="text" value="Orange Pod Update: Excused Absences, Accessibility, and Events">
        </div>

        <div class="section">
          <h3>Key Updates</h3>
          <div id="updatesEditor" class="rte" contenteditable="true"></div>
          <div class="footer-note" style="margin-top:8px;font-style:italic;">ðŸ’¡ Law students need bullet point summaries! please.</div>
          <div class="row">
            <button id="clearUpdates" class="btn ghost" type="button">Clear</button>
          </div>
        </div>

        <div class="section">
          <h3>Sections</h3>
          <div id="sections"></div>
          <button id="addSection" class="btn ghost">+ Add Section</button>
        </div>

        <div class="section">
          <h3>Signature</h3>
          <div id="signatureEditor" class="rte" contenteditable="true"></div>
        </div>

      </div>

      <div class="panel preview">
        <div class="iframe-wrap">
          <iframe id="preview" title="Email Preview" style="width:100%;height:80vh;border:0"></iframe>
        </div>
      </div>
    </div>

    <footer style="text-align: center; padding: 20px; color: var(--muted); font-size: 12px; border-top: 1px solid #e5e7eb; margin-top: 40px;">
      Â© 2025 Alec Palm
    </footer>

    <!-- Custom Modals -->
    <div id="linkModal" class="modal-overlay">
      <div class="modal">
        <h3>Add Link</h3>
        <input id="linkUrl" type="url" placeholder="https://example.com" />
        <div class="modal-buttons">
          <button id="linkCancel" class="modal-btn">Cancel</button>
          <button id="linkConfirm" class="modal-btn primary">Add Link</button>
        </div>
      </div>
    </div>

    <div id="copyModal" class="modal-overlay">
      <div class="modal">
        <h3>âœ… HTML Copied!</h3>
        <p>To use your email template in Gmail:</p>
        <ol style="margin:0 0 20px 0;padding-left:20px;color:#6b7280;">
          <li>Compose a new email in Gmail</li>
          <li>Paste your HTML in the compose area</li>
        </ol>
        <div class="modal-buttons">
          <button id="copyClose" class="modal-btn primary">Got it!</button>
        </div>
      </div>
    </div>

  </div>

  <template id="updateItemTpl">
    <div class="section" data-kind="update">
      <div class="row">
        <input type="text" placeholder="Update text...">
        <button class="btn ghost" data-action="remove">Remove Update</button>
      </div>
    </div>
  </template>

  <template id="sectionItemTpl">
    <div class="section" data-kind="section">
      <div class="row">
        <button class="btn ghost toggle-title-btn" type="button" style="font-size:12px;padding:4px 8px;">+ Add Title</button>
      </div>
      <div class="title-container" style="display:none;margin-bottom:12px;">
        <input type="text" placeholder="Section title" style="width:100%;padding:8px;border:1px solid #e5e7eb;border-radius:6px;">
      </div>
      <label>Content</label>
      <div class="rte" contenteditable="true"></div>
      <div style="margin-top:8px;text-align:left;">
        <button class="btn ghost" data-action="remove" style="font-size:12px;padding:4px 8px;">Remove Section</button>
      </div>
    </div>
  </template>

  <script>
    const el = id => document.getElementById(id);
    const state = {
      colors: { primary: '#65ab6f', accent: '#0066cc', heroText: '#ffffff' }, // customizable palette
      logos: {
        blue: {
          left: '', // Upload sba-blue.png to a public hosting service and paste URL here
          right: '' // Upload lewisclark-blue.png to a public hosting service and paste URL here
        },
        white: {
          left: '', // Upload sba-white.png to a public hosting service and paste URL here
          right: '' // Upload lewisclark-white.png to a public hosting service and paste URL here
        }
      },
      logoVariant: 'white',
      hero: {
        headline: 'A Message from Your<br>Student Bar Representatives',
        subheadline: 'Lewis & Clark Law Student Bar Association',
        preheader: 'SBA Update: Excused Absences, Accessibility, and Events'
      },
      updatesHtml: '<ul><li>Excused absences available for illness - contact Dean Libby Davis</li><li>Report accessibility concerns through DALSA or student reps</li><li>Pod event funding available - share your ideas!</li></ul>',
      sections: [
        { title: '', body: `Welcome to the Orange Pod! We're your SBA representatives and we're here to support you throughout the year. Feel free to reach out with any questions or concerns.`, showTitle: false },
        { title: 'Health & Safety Update', body: `We're monitoring campus health concerns and have expanded excused absence options. If you're unwell, contact Dean Libby Davis to request an <a href=\"https://law.lclark.edu/live/forms/1833-excused-absence-request-form\">excused absence</a>.`, showTitle: true },
      ],
      signature: 'Best,<br>Alec Palm<br>SBA Representative',
      footer: { url: 'https://law.lclark.edu/student_groups/student_bar_association/', text: 'Lewis & Clark Law Student Bar Association' },
    };
    // Customizable color palette

    function clampHex(hex){
      const v = /^#?[0-9a-fA-F]{6}$/.test(hex) ? (hex[0]==='#'? hex : '#'+hex) : null;
      return v || '#000000';
    }

    function hexToRgb(hex){
      hex = clampHex(hex).replace('#','');
      const r = parseInt(hex.substr(0,2),16);
      const g = parseInt(hex.substr(2,2),16);
      const b = parseInt(hex.substr(4,2),16);
      return `${r}, ${g}, ${b}`;
    }

    function hasContent(html){
      if (!html || typeof html !== 'string') return false;
      // Remove HTML tags and check if there's actual text content
      const textContent = html.replace(/<[^>]*>/g, '').trim();
      return textContent.length > 0;
    }

    // Modal management functions
    function showModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.classList.add('show');
        // Focus first input if available
        const input = modal.querySelector('input');
        if (input) {
          setTimeout(() => input.focus(), 100);
        }
      }
    }

    function hideModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.classList.remove('show');
      }
    }

    function hideAllModals() {
      document.querySelectorAll('.modal-overlay').forEach(modal => {
        modal.classList.remove('show');
      });
    }

    function shade(hex, percent){
      hex = clampHex(hex).replace('#','');
      const num = parseInt(hex,16);
      const amt = Math.round(2.55*percent);
      const r = (num>>16) + amt;
      const g = (num>>8 & 0x00FF) + amt;
      const b = (num & 0x0000FF) + amt;
      return '#' + (
        0x1000000 +
        (r<255? (r<0?0:r):255)*0x10000 +
        (g<255? (g<0?0:g):255)*0x100 +
        (b<255? (b<0?0:b):255)
      ).toString(16).slice(1);
    }

    function buildEmailHTML(s){
      const primary = clampHex(s.colors.primary);
      const accent = clampHex(s.colors.accent);
      const primaryDark = shade(primary,-15);
      const headerBg = `linear-gradient(180deg, ${primary} 0%, ${shade(primary,-10)} 100%)`;
      const cardBg = shade(primary, 45);
      const cardText = primary;
      const divider = '#eee';

      const escapeAttr = t => String(t||'').replace(/"/g,'&quot;');

      const logos = s.logos[s.logoVariant === 'black' ? 'white' : s.logoVariant] || s.logos.white;
      const logoClass = s.logoVariant === 'black' ? 'logo-black' : '';
      const doc = `<!DOCTYPE html>
<html lang="en"><head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="x-apple-data-detectors" content="true">
<style>.logo-black{filter: invert(1) brightness(0.8)}</style>
</head>
<body style="font-family: 'Helvetica Neue', Arial, sans-serif; line-height: 1.6; color: #333; margin: 0; padding: 0; background-color: #f6f6f6;">
  ${s.hero.preheader ? `<div style="color: transparent; font-size: 0px; line-height: 0px; max-height: 0px; overflow: hidden;">${s.hero.preheader} | </div>` : ''}
  <div style="max-width: 640px; margin: 20px auto; background-color: #ffffff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); overflow: hidden;">
    <div style="text-align: center; padding: 10px 15px; background: ${headerBg}; color: #ffffff; border-radius: 8px 8px 0 0; border-bottom: 4px solid ${primaryDark};">
      <div style="text-align: center; padding: 8px 0;">
        ${logos.left ? `<img src="${escapeAttr(logos.left)}" alt="Left Logo" class="${logoClass}" style="max-height: 55px; display: inline-block; vertical-align: middle;">` : ''}
        <span style="display: inline-block; width: 2px; height: 35px; background-color: rgba(255, 255, 255, 0.85); margin: 0 20px; vertical-align: middle;"></span>
        ${logos.right ? `<img src="${escapeAttr(logos.right)}" alt="Right Logo" class="${logoClass}" style="max-height: 55px; display: inline-block; vertical-align: middle;">` : ''}
      </div>
      <h1 style="margin: 8px 0 3px 0; font-size: 20px; font-weight: 700; text-transform: uppercase; letter-spacing: 1.2px; line-height: 1.2; color: ${s.colors.heroText};">
        <span>${s.hero.headline}</span>
      </h1>
      <p style="margin: 3px 0 8px 0; font-size: 13px; font-weight: 400; opacity: 0.95; line-height: 1.4; color: ${s.colors.heroText};">${s.hero.subheadline}</p>
    </div>
    ${s.updatesHtml && s.updatesHtml.trim() ? `
    <div style="background-color: rgba(${hexToRgb(primary)}, 0.1); padding: 15px; margin: 20px; border-radius: 8px; border-left: 5px solid ${primary}; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);">
      <h2 style="color: ${cardText}; font-size: 19px; margin: 0 0 10px 0; font-weight: 600; letter-spacing: 0.5px;">Key Updates</h2>
      <div style="margin: 0; padding-left: 0; font-size: 15px; line-height: 1.6;">${s.updatesHtml.replace(/href="([^"]*)"/g, `style="color: ${primary}; text-decoration: none; font-weight: 500;" href="$1"`)}</div>
    </div>`: ''}
    <div style="padding: 0 20px 20px;">
      ${s.sections.map(sec=>`
        ${sec.showTitle && sec.title && sec.title.trim() ? `<h3 style=\"color: ${primary}; font-size: 17px; font-weight: 600; margin: 20px 0 10px; letter-spacing: 0.3px;\">${sec.title}</h3>` : ''}
        <div style=\"margin: 10px 0; font-size: 15px; line-height: 1.7;\">${sec.body.replace(/href="([^"]*)"/g, `style="color: ${primary}; text-decoration: none; font-weight: 500;" href="$1"`)}</div>
      `).join('')}
      ${hasContent(s.signature) ? `<p style="margin-top: 15px; font-size: 15px; color: #444; padding: 15px 0; border-top: 1px solid ${divider};">${s.signature}</p>` : ''}
    </div>
    <div style="text-align: center; font-size: 13px; color: #555; padding: 15px; background-color: #f9f9f9; border-top: 1px solid #ddd; border-radius: 0 0 12px 12px;">
      <p> ${s.footer.url && s.footer.text ? `<a href="${escapeAttr(s.footer.url)}" style="color: ${primary}; text-decoration: none; font-weight: 500;">${s.footer.text}</a>`: ''}</p>
    </div>
  </div>
</body></html>`;
      return doc;
    }

    function render(){
      try {
        const html = buildEmailHTML(state);
        const iframe = el('preview');
        if (iframe) {
          iframe.srcdoc = html;
        }
        // Save state with error handling
        try {
          localStorage.setItem('email-builder-state', JSON.stringify(state));
        } catch (e) {
          console.warn('Failed to save state to localStorage:', e);
        }
      } catch (e) {
        console.error('Error rendering email:', e);
      }
    }

    function syncInputs(){
      // Branding - colors and logo variant
      el('primaryColor').value = state.colors.primary;
      el('primaryHex').value = state.colors.primary;
      el('heroTextColor').value = state.colors.heroText;
      el('heroTextHex').value = state.colors.heroText;
      document.getElementById('logoBlue').classList.toggle('selected', state.logoVariant==='blue');
      document.getElementById('logoWhite').classList.toggle('selected', state.logoVariant==='white');
      document.getElementById('logoBlack').classList.toggle('selected', state.logoVariant==='black');
      // Hero
      document.getElementById('headlineEditor').innerHTML = state.hero.headline;
      document.getElementById('subheadlineEditor').innerHTML = state.hero.subheadline;
      el('preheader').value = state.hero.preheader;
      // Updates RTE
      document.getElementById('updatesEditor').innerHTML = state.updatesHtml || '';
      // Signature RTE
      document.getElementById('signatureEditor').innerHTML = state.signature || '';

      const sectionsWrap = document.getElementById('sections');
      sectionsWrap.innerHTML='';
      state.sections.forEach((sec, idx)=>{
        const tpl = document.getElementById('sectionItemTpl');
        if (!tpl || !tpl.content) return;
        const node = tpl.content.firstElementChild.cloneNode(true);
        const toggleBtn = node.querySelector('.toggle-title-btn');
        const titleContainer = node.querySelector('.title-container');
        const titleInput = node.querySelector('input');
        const bodyDiv = node.querySelector('.rte');

        // Skip if required elements are missing
        if (!toggleBtn || !titleContainer || !titleInput || !bodyDiv) {
          console.warn('Template missing required elements, skipping section');
          return;
        }

        // Set up title toggle
        const updateTitleDisplay = () => {
          if (sec.showTitle) {
            titleContainer.style.display = 'block';
            titleContainer.classList.remove('hide-title');
            titleContainer.classList.add('show-title');
            toggleBtn.textContent = 'âˆ’ Remove Title';
          } else {
            titleContainer.classList.remove('show-title');
            titleContainer.classList.add('hide-title');
            // Delay hiding to let animation complete - capture current state
            const shouldHide = !sec.showTitle;
            setTimeout(() => {
              if (shouldHide) {
                titleContainer.style.display = 'none';
                titleContainer.classList.remove('hide-title');
              }
            }, 300);
            toggleBtn.textContent = '+ Add Title';
          }
        };

        toggleBtn.addEventListener('click', () => {
          sec.showTitle = !sec.showTitle;
          updateTitleDisplay();
          render();
        });

        updateTitleDisplay();
        titleInput.value = sec.title;
        bodyDiv.innerHTML = sec.body;

        titleInput.addEventListener('input', e=>{ state.sections[idx].title = e.target.value; render(); });
        bodyDiv.addEventListener('input', e=>{ state.sections[idx].body = e.target.innerHTML; render(); });
        const removeBtn = node.querySelector('[data-action="remove"]');
        if (removeBtn) {
          removeBtn.addEventListener('click', ()=>{ state.sections.splice(idx,1); syncInputs(); render(); });
        }
        sectionsWrap.appendChild(node);
      });
    }
    // No presets toolbar

    function wire(){
      // Colors
      const primaryGroup = ()=>{ const v = clampHex(el('primaryHex').value); el('primaryHex').value=v; el('primaryColor').value=v; state.colors.primary=v; render(); };
      const heroTextGroup = ()=>{ const v = clampHex(el('heroTextHex').value); el('heroTextHex').value=v; el('heroTextColor').value=v; state.colors.heroText=v; render(); };
      el('primaryColor').addEventListener('input', e=>{ el('primaryHex').value=e.target.value; primaryGroup(); });
      el('primaryHex').addEventListener('change', primaryGroup);
      el('heroTextColor').addEventListener('input', e=>{ el('heroTextHex').value=e.target.value; heroTextGroup(); });
      el('heroTextHex').addEventListener('change', heroTextGroup);
      // Logo variant
      document.getElementById('logoBlue').addEventListener('click', ()=>{ state.logoVariant='blue'; syncInputs(); render(); });
      document.getElementById('logoWhite').addEventListener('click', ()=>{ state.logoVariant='white'; syncInputs(); render(); });
      document.getElementById('logoBlack').addEventListener('click', ()=>{ state.logoVariant='black'; syncInputs(); render(); });
      // Headlines RTE
      document.getElementById('headlineEditor').addEventListener('input', e=>{ state.hero.headline=e.target.innerHTML; render(); });
      document.getElementById('subheadlineEditor').addEventListener('input', e=>{ state.hero.subheadline=e.target.innerHTML; render(); });
      el('preheader').addEventListener('input', e=>{ state.hero.preheader=e.target.value; render(); });
      document.getElementById('updatesEditor').addEventListener('input', e=>{ state.updatesHtml = e.target.innerHTML; render(); });
      document.getElementById('signatureEditor').addEventListener('input', e=>{ state.signature = e.target.innerHTML; render(); });
      el('clearUpdates').addEventListener('click', ()=>{ state.updatesHtml = ''; syncInputs(); render(); });
      el('addSection').addEventListener('click', ()=>{
        state.sections.push({title:'', body:'New section content...', showTitle: false});
        syncInputs();
        render();
        // Animate the new section
        setTimeout(() => {
          const sections = document.querySelectorAll('.section');
          const newSection = sections[sections.length - 1]; // Get the last (newest) section
          if (newSection) {
            newSection.classList.add('new-section');
            // Remove the animation class after it completes
            setTimeout(() => {
              newSection.classList.remove('new-section');
            }, 400);
          }
        }, 10); // Small delay to ensure DOM is updated
      });

      // Modal event listeners
      el('linkCancel').addEventListener('click', () => hideModal('linkModal'));
      el('linkConfirm').addEventListener('click', () => {
        const url = el('linkUrl').value.trim();
        if (url) {
          document.execCommand('createLink', false, url);
        }
        el('linkUrl').value = '';
        hideModal('linkModal');
      });
      el('copyClose').addEventListener('click', () => hideModal('copyModal'));

      // Close modals when clicking overlay
      document.querySelectorAll('.modal-overlay').forEach(overlay => {
        overlay.addEventListener('click', (e) => {
          if (e.target === overlay) {
            hideAllModals();
          }
        });
      });

      // Close modals on Escape key and handle Enter in link modal
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          hideAllModals();
        } else if (e.key === 'Enter' && document.getElementById('linkModal').classList.contains('show')) {
          // Confirm link when Enter is pressed in link modal
          const url = el('linkUrl').value.trim();
          if (url) {
            document.execCommand('createLink', false, url);
          }
          el('linkUrl').value = '';
          hideModal('linkModal');
        }
      });

      el('resetDefaults').addEventListener('click', ()=>{
        const container = document.querySelector('.container');
        container.classList.add('resetting');
        setTimeout(() => {
          localStorage.removeItem('email-builder-state');
          location.reload();
        }, 400); // Wait for fade out animation
      });

      el('copyHtml').addEventListener('click', async ()=>{
        try {
          const html = buildEmailHTML(state);
          // Use ClipboardItem (best) with text/html; fallback to text-only
          if (navigator.clipboard && window.ClipboardItem) {
            const blob = new Blob([html], { type: 'text/html' });
            await navigator.clipboard.write([new ClipboardItem({ 'text/html': blob, 'text/plain': new Blob([html], { type: 'text/plain' }) })]);
          } else if (navigator.clipboard) {
            await navigator.clipboard.writeText(html);
          } else {
            // Fallback for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = html;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
          }
          showModal('copyModal');
        } catch(err) {
          console.error('Copy failed:', err);
          alert('Could not copy. Please try again or copy manually from the preview.');
        }
      });

    }

    // Simple RTE toolbar using execCommand (widely supported)
    function wireToolbar(){
      let lastFocused = null;
      const toolbar = document.getElementById('rteToolbar');

      // Make toolbar morph bigger when sticky
      let isSticky = false;
      const checkSticky = () => {
        if (!toolbar) return;
        try {
          const rect = toolbar.getBoundingClientRect();
          const shouldBeSticky = rect.top <= 0;

          if (shouldBeSticky !== isSticky) {
            isSticky = shouldBeSticky;
            if (isSticky) {
              toolbar.classList.add('sticky');
            } else {
              toolbar.classList.remove('sticky');
            }
          }
        } catch (e) {
          console.warn('Error checking sticky state:', e);
        }
      };

      // Check on scroll and resize
      window.addEventListener('scroll', checkSticky, { passive: true });
      window.addEventListener('resize', checkSticky, { passive: true });

      // Initial check
      checkSticky();

      document.addEventListener('focusin', (e)=>{
        if (e.target.classList && e.target.classList.contains('rte')) lastFocused = e.target;
      });
      toolbar.addEventListener('click', (e)=>{
        const btn = e.target.closest('button');
        if (!btn) return;
        e.preventDefault();
        const cmd = btn.getAttribute('data-cmd');
        const action = btn.getAttribute('data-action');
        if (lastFocused) lastFocused.focus();
          if (cmd) document.execCommand(cmd, false, null);
          if (action === 'link') {
            showModal('linkModal');
          }
        if (action === 'clearFormat') {
          document.execCommand('removeFormat');
          document.execCommand('unlink');
        }
      });
    }

    (function init(){
      try{
        const saved = localStorage.getItem('email-builder-state');
        if (saved) {
          const parsed = JSON.parse(saved);
          // Validate basic structure before merging
          if (parsed && typeof parsed === 'object' &&
              parsed.colors && typeof parsed.colors === 'object' &&
              parsed.hero && typeof parsed.hero === 'object' &&
              Array.isArray(parsed.sections)) {
            Object.assign(state, parsed);
          } else {
            console.warn('Invalid saved state structure, using defaults');
          }
        }
      }catch(e){
        console.warn('Failed to load saved state:', e);
      }
      wireToolbar();
      syncInputs();
      wire();
      render();
    })();
  </script>
</body>
</html>
